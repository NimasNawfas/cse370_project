<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leave - Smart Labour</title>
    
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    
    <style>
        /* Add error/success message styles */
        .alert-flash {
            animation: slideIn 0.5s ease-out;
        }
        
        @keyframes slideIn {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .error-message {
            color: #dc3545;
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }
    </style>
</head>
<body>
    <!-- Navigation (Keep your existing navigation) -->

    <!-- Main Content -->
    <div class="container py-4">
        <!-- Display Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ 'success' if category == 'success' else 'danger' }} alert-dismissible fade show alert-flash" role="alert">
                        <i class="bi bi-{{ 'check-circle' if category == 'success' else 'exclamation-triangle' }} me-2"></i>
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <!-- Display URL parameter messages -->
        {% if request.args.get('error') %}
        <div class="alert alert-danger alert-dismissible fade show alert-flash" role="alert">
            <i class="bi bi-exclamation-triangle me-2"></i>
            {% if request.args.get('error') == 'missing_fields' %}
                Please fill all required fields.
            {% elif request.args.get('error') == 'invalid_dates' %}
                End date must be after start date.
            {% elif request.args.get('error') == 'past_date' %}
                Cannot apply for leave in the past.
            {% elif request.args.get('error') == 'invalid_date_format' %}
                Invalid date format. Please use YYYY-MM-DD.
            {% elif request.args.get('error') == 'overlapping_leave' %}
                You already have approved leave during this period.
            {% else %}
                Error: {{ request.args.get('error') }}
            {% endif %}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        {% endif %}

        {% if request.args.get('success') %}
        <div class="alert alert-success alert-dismissible fade show alert-flash" role="alert">
            <i class="bi bi-check-circle me-2"></i>
            Leave request submitted successfully!
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        {% endif %}

        <!-- Header and rest of your existing content -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1 class="fw-bold mb-2">Leave Management</h1>
                <p class="text-muted mb-0">Apply for leave and track your leave balance</p>
            </div>
        </div>

        <!-- Your existing leave balance cards -->

        <!-- Leave History -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">My Leave Requests</h5>
            </div>
            <div class="card-body">
                {% if leave_requests %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Type</th>
                                <th>Start Date</th>
                                <th>End Date</th>
                                <th>Reason</th>
                                <th>Applied Date</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for request in leave_requests %}
                            <tr>
                                <td>{{ request.leave_type|title }}</td>
                                <td>{{ request.start_date }}</td>
                                <td>{{ request.end_date }}</td>
                                <td>{{ request.reason|truncate(30) }}</td>
                                <td>{{ request.applied_date }}</td>
                                <td>
                                    <span class="badge bg-{% if request.status == 'Approved' %}success{% elif request.status == 'Rejected' %}danger{% else %}warning{% endif %}">
                                        {{ request.status }}
                                    </span>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="bi bi-calendar-x fs-1 text-muted mb-3"></i>
                    <p class="text-muted">No leave requests found.</p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Apply for Leave Form -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Apply for New Leave</h5>
            </div>
            <div class="card-body">
                <form method="POST" action="/worker/leave/request" id="leaveForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-semibold">Leave Type *</label>
                            <select class="form-select" name="leave_type" required id="leaveType">
                                <option value="">Select leave type...</option>
                                <option value="casual">Casual Leave ({{ leave_balance.casual }} days left)</option>
                                <option value="sick">Sick Leave ({{ leave_balance.sick }} days left)</option>
                                <option value="annual">Annual Leave ({{ leave_balance.annual }} days left)</option>
                            </select>
                            <div class="error-message" id="leaveTypeError"></div>
                        </div>
                        
                        <div class="col-md-3 mb-3">
                            <label class="form-label fw-semibold">Start Date *</label>
                            <input type="date" class="form-control" name="start_date" required 
                                   id="startDate" min="{{ today }}">
                            <div class="error-message" id="startDateError"></div>
                        </div>
                        
                        <div class="col-md-3 mb-3">
                            <label class="form-label fw-semibold">End Date *</label>
                            <input type="date" class="form-control" name="end_date" required 
                                   id="endDate" min="{{ today }}">
                            <div class="error-message" id="endDateError"></div>
                        </div>
                        
                        <div class="col-12 mb-3">
                            <label class="form-label fw-semibold">Reason *</label>
                            <textarea class="form-control" name="reason" rows="3" required 
                                      placeholder="Please provide reason for leave..." 
                                      id="reason"></textarea>
                            <div class="error-message" id="reasonError"></div>
                        </div>
                        
                        <div class="col-12">
                            <button type="submit" class="btn btn-primary" id="submitBtn">
                                <i class="bi bi-send me-2"></i>Submit Leave Request
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    
    <script>
        // Frontend validation
        document.getElementById('leaveForm').addEventListener('submit', function(e) {
            let isValid = true;
            
            // Clear previous errors
            document.querySelectorAll('.error-message').forEach(el => el.textContent = '');
            
            // Validate leave type
            const leaveType = document.getElementById('leaveType');
            if (!leaveType.value) {
                document.getElementById('leaveTypeError').textContent = 'Please select leave type';
                isValid = false;
            }
            
            // Validate dates
            const startDate = new Date(document.getElementById('startDate').value);
            const endDate = new Date(document.getElementById('endDate').value);
            
            if (!document.getElementById('startDate').value) {
                document.getElementById('startDateError').textContent = 'Please select start date';
                isValid = false;
            }
            
            if (!document.getElementById('endDate').value) {
                document.getElementById('endDateError').textContent = 'Please select end date';
                isValid = false;
            }
            
            if (document.getElementById('startDate').value && document.getElementById('endDate').value) {
                if (endDate < startDate) {
                    document.getElementById('endDateError').textContent = 'End date must be after start date';
                    isValid = false;
                }
            }
            
            // Validate reason
            const reason = document.getElementById('reason');
            if (!reason.value.trim()) {
                document.getElementById('reasonError').textContent = 'Please provide reason for leave';
                isValid = false;
            }
            
            if (!isValid) {
                e.preventDefault();
                return false;
            }
            
            // Disable submit button and show loading
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Submitting...';
        });
        
        // Set min date for date inputs to today
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('startDate').min = today;
        document.getElementById('endDate').min = today;
        
        // Update end date min when start date changes
        document.getElementById('startDate').addEventListener('change', function() {
            document.getElementById('endDate').min = this.value;
        });
    </script>
</body>
</html>